<!DOCTYPE html>
<html>
  <head>
    <title>My experiment</title>
    <style>
      #submit-container {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh; /* Full viewport height */
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
      }

      .instructions-container {
        display: flex;
        justify-content: space-around;
        align-items: center;
      }

      .instruction-box {
        border: 1px solid #ccc; /* Box border */
        padding: 10px;
        width: 48%; /* Adjust width as needed */
        box-sizing: border-box;
      }

      .instruction {
        margin: 0 10px;
        text-align: left; /* Align text to the left */
        /* Add more styling as needed */
      }

      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }   
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="jspsych/jspsych.js"></script>
    <script src="jspsych/plugin-html-slider-response.js"></script> 
    <script src="https://proliferate.alps.science/static/js/proliferate.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link href="jspsych/jspsych.css" rel="stylesheet" type="text/css" />
  </head>
  <body>

    <script>
      const jsPsych = initJsPsych();

      function parseCsv(csvText) {
        return new Promise((resolve, reject) => {
          Papa.parse(csvText, {
            header: true,
            complete: (results) => {
              resolve(results.data);
            },
            error: (error) => {
              reject(error);
            }
          });
        });
      }
      
      // Function to fetch and parse CSV data
      async function fetchCsvData(url) {
        const response = await fetch(url);
        const csvText = await response.text();
        // Parse the CSV text into an array of objects (you might need a CSV parsing library or write a custom parser)
        const data = await parseCsv(csvText);
        return data;
      }
    
      // Function to create trials from CSV data
      function createTrialsFromCsvData(csvData) {
        const results = csvData.map(row => ({
          type: jsPsychHtmlSliderResponse,
          stimulus: `
            <div class="instructions-container">
              <div class="instruction-box">
                <label for="instruction-A">Instruction A</label>
                <div class="instruction" id="instruction-A">${row.instruction_A.replace(/\n/g, '<br>')}</div>
              </div>
              <div class="instruction-box">
                <label for="instruction-B">Instruction B</label>
                <div class="instruction" id="instruction-B">${row.instruction_B.replace(/\n/g, '<br>')}</div>
              </div>
            </div>`,
          labels: ['Strongly prefer A', 'Neutral', 'Strongly prefer B'],
          min: -1,
          max: 1,
          start: 0,
          step: 0.01,
          slider_width: 400,
          index_A: row.index_A,
          index_B: row.index_B
        }));
        console.log(results[0]);
        return results;
      }
    
      // Main experiment setup
      async function setupExperiment() {
        const csvData = await fetchCsvData('worksheet_pairs_20240101_sample.csv');
        const trials = createTrialsFromCsvData(csvData);
    
        jsPsych.run(trials).then(() => {
          console.log("Trial data after experiment:", jsPsych.data.get().values());
          const submitButtonHTML = `
            <div id="submit-container">
              <button id="submit-btn" onclick="submitToProliferate()">Submit</button>
            </div>`;
          document.body.insertAdjacentHTML('beforeend', submitButtonHTML);
        });
      }

      function submitToProliferate() {
        // Retrieve trial data including index_A and index_B
        const trialData = jsPsych.data.get().values();
        // Log each trial data to inspect
        trialData.forEach((trial, index) => {
          console.log(`Trial ${index}:`, trial);
        });
        // Map each trial to include index_A and index_B in the response
        const responses = trialData.map(trial => {
          return {
            ...trial, // includes all trial data
            index_A: trial.index_A,
            index_B: trial.index_B
          };
        });
        console.log(responses);

        const surveyData = {
          responses: JSON.stringify(responses) // Convert the responses to a JSON string
        };

        // Submit the data to Proliferate
        proliferate.submit(surveyData);

        // Display a thank you message
        document.body.innerHTML = '<p>Thank you for completing the survey!</p>';
      }

      setupExperiment();
    </script>    

  </body>
</html>