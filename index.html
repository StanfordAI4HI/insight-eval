<!DOCTYPE html>
<html>
  <head>
    <title>My experiment</title>
    <style>
      #submit-container {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh; /* Full viewport height */
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
      }

      .instructions-container {
        display: flex;
        justify-content: space-around;
        align-items: flex-start;
      }

      .instruction-box {
        border: 1px solid #ccc;
        padding: 10px;
        width: 48%;
        box-sizing: border-box;
        display: flex; /* Added flex display */
        flex-direction: column; /* Direct children to organize in a column */
      }
      
      .instruction {
        margin: 0 10px;
        text-align: left; /* Align text to the left */
        /* Add more styling as needed */
      }

      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }   
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="jspsych/jspsych.js"></script>
    <script src="jspsych/plugin-html-slider-response.js"></script> 
    <script src="jspsych/plugin-html-button-response.js"></script>
    <script src="https://proliferate.alps.science/static/js/proliferate.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link href="jspsych/jspsych.css" rel="stylesheet" type="text/css" />
  </head>
  <body>

    <script>
      const jsPsych = initJsPsych();

      function parseCsv(csvText) {
        return new Promise((resolve, reject) => {
          Papa.parse(csvText, {
            header: true,
            complete: (results) => {
              resolve(results.data);
            },
            error: (error) => {
              reject(error);
            }
          });
        });
      }
      
      // Function to fetch and parse CSV data
      async function fetchCsvData(url) {
        const response = await fetch(url);
        const csvText = await response.text();
        // Parse the CSV text into an array of objects (you might need a CSV parsing library or write a custom parser)
        const data = await parseCsv(csvText);
        return data;
      }

      function getRandomSubset(data, subsetSize) {
        let shuffled = data.slice(); // Copy the array
        for (let i = shuffled.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]]; // Swap
        }
        return shuffled.slice(0, subsetSize); // Return the subset
      }

      // Function to create trials from CSV data
      function createTrialsFromCsvData(csvData) {
        const results = csvData.map(row => ({
          type: jsPsychHtmlSliderResponse,
          stimulus: `
            <div class="content-container"> <!-- New container for the entire content -->
              <div style="text-align: center; margin-bottom: 20px;"> <!-- Container for the text -->
                <strong>Which worksheet would be more useful for the 8th-grade student in terms of improving their test performance? Please keep in mind that the student will not receive any extra feedback or guidance beyond what is provided in the worksheet itself.</strong><br>
              </div>
              <div class="instructions-container"> <!-- Existing instructions container -->
                <div class="instruction-box">
                  <label for="instruction-A">Worksheet A</label>
                  <div class="instruction" id="instruction-A">${row.instruction_A.replace(/\n/g, '<br>')}</div>
                </div>
                <div class="instruction-box">
                  <label for="instruction-B">Worksheet B</label>
                  <div class="instruction" id="instruction-B">${row.instruction_B.replace(/\n/g, '<br>')}</div>
                </div>
              </div>
            </div>`,
          labels: ['Strongly prefer A', 'Neutral', 'Strongly prefer B'],
          min: -1,
          max: 1,
          start: 0,
          step: 0.01,
          slider_width: 400,
          data: {
            index_A: row.index_A,
            index_B: row.index_B
          }
        }));
        return results;
      }

      // Function to create a single catch trial
      function createCatchTrial(csvData) {
        // Assuming the catch trial csv has only one row
        const row = csvData[0];
        return {
          type: jsPsychHtmlSliderResponse,
          stimulus: `
            <div class="content-container"> <!-- New container for the entire content -->
              <div style="text-align: center; margin-bottom: 20px;"> <!-- Container for the text -->
                <strong>Which worksheet would be more useful for the 8th-grade student in terms of improving their test performance? Please keep in mind that the student will not receive any extra feedback or guidance beyond what is provided in the worksheet itself.</strong><br>
              </div>
              <div class="instructions-container"> <!-- Existing instructions container -->
                <div class="instruction-box">
                  <label for="instruction-A">Worksheet A</label>
                  <div class="instruction" id="instruction-A">${row.instruction_A.replace(/\n/g, '<br>')}</div>
                </div>
                <div class="instruction-box">
                  <label for="instruction-B">Worksheet B</label>
                  <div class="instruction" id="instruction-B">${row.instruction_B.replace(/\n/g, '<br>')}</div>
                </div>
              </div>
            </div>`,
          labels: ['Strongly prefer A', 'Neutral', 'Strongly prefer B'],
          min: -1,
          max: 1,
          start: 0,
          step: 0.01,
          slider_width: 400,
          data: {
            index_A: row.index_A,
            index_B: row.index_B
          }
        };
      }
 
      const consentForm = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `
            <div style="text-align:center; margin-bottom: 20px;">
                <h2>Consent Form</h2>
                <p>Please read the following consent form carefully before proceeding.</p>
                <div style="text-align:left; margin: 20px;">
                  <!-- Add your consent form text here -->
                  <p>[Consent form text goes here...]</p>
                </div>
            </div>`,
        choices: ['I Agree']
      };

      // Main experiment setup
      async function setupExperiment() {
        const csvData = await fetchCsvData('worksheet_pairs_20240108_three.csv');
        const catchData = await fetchCsvData('catch_trial.csv');
        const subsetSize = 3;
        const randomSubset = getRandomSubset(csvData, subsetSize);
        const trials = createTrialsFromCsvData(randomSubset);
        const catchTrial = createCatchTrial(catchData);
 
        // Introduction trial
        const introduction = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `
                <div style="text-align:center; margin-bottom: 20px;">
                    <h2>Introduction</h2>
                    <p>Imagine an 8th-grade student who has been taught how to tackle math word problems on setting up and solving systems of equations but hasn't yet had the opportunity to practice them. This student is about to receive a worksheet to complete before an upcoming test. We will present you with pairs of these worksheets. Your task is to evaluate and compare how useful each worksheet would be for the student. These worksheets were generated by AI and/or humans. There may be errors in them. Sometimes there may be significant differences between the two worksheets, but sometimes they may seem very similar. </p>
                </div>`,
            choices: ['Begin']
        };
        trials.unshift(introduction);
        trials.unshift(consentForm);
        trials.splice(1, 0, catchTrial);

        jsPsych.run(trials).then(() => {
          const submitButtonHTML = `
            <div id="submit-container">
              <button id="submit-btn" onclick="submitToProliferate()">Submit</button>
            </div>`;
          document.body.insertAdjacentHTML('beforeend', submitButtonHTML);
        });
      }

      function submitToProliferate() {
        // Retrieve trial data including index_A and index_B
        const trialData = jsPsych.data.get().values();

        // Map each trial to include index_A and index_B in the response
        const responses = trialData.map(trial => {
          return {
            ...trial, // includes all trial data
            index_A: trial.index_A,
            index_B: trial.index_B
          };
        });

        const surveyData = {
          responses: JSON.stringify(responses) // Convert the responses to a JSON string
        };

        // Submit the data to Proliferate
        proliferate.submit(surveyData);

        // Display a thank you message
        document.body.innerHTML = '<p>Please wait for 5 seconds before closing the page. Thank you for completing the survey!</p>';
      }

      setupExperiment();
    </script>    

  </body>
</html>